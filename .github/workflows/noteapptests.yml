name: NoteApp Full Test Pipeline

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- Node.js Setup for Backend & API/Cypress Tests ---
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Adjust to your project's Node.js version
          cache: 'npm'

      - name: Install Node.js Dependencies
        run: npm ci

      # --- Python Setup for Robot Framework Tests ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' # e.g., '3.9', '3.10', '3.11'

      - name: Install Robot Framework and Libraries
        run: |
          python -m pip install --upgrade pip
          pip install robotframework robotframework-seleniumlibrary
          # Add any other pip installs for Robot Framework libraries here if needed

      # --- Start Backend Server ---
      - name: Start Backend Server
        # Your server.js appears to be in the root directory.
        run: |
          node server.js &
          npx wait-on http://localhost:3001
        env:
          PORT: 3001 # Ensure this matches your server's listening port

      # --- Run Jest API Tests (Supertest) ---
      - name: Run Jest API Tests
        # The 'npm test:api' script (which should call 'jest') will automatically
        # find jest.config.js and tests/apitests.test.js because Jest is configured
        # to look for files based on your 'testMatch' or 'testRegex' patterns.
        # Ensure your jest.config.js has something like:
        # testMatch: ["**/tests/**/*.test.js"],
        # OR collectCoverageFrom: ["server.js", "tests/**/*.js"]
        run: npm run test:api -- --coverage

      # --- Run Cypress E2E Tests ---
      - name: Run Cypress E2E Tests (using notes.cy.js)
        uses: cypress-io/github-action@v6
        with:
          start: npm start # or 'node server.js' if not in package.json script
          wait-on: 'http://localhost:3001'
          browser: chrome
          headed: false
          # Explicitly target the spec file based on your screenshot
          spec: 'remwaste_cypressaut/notes.cy.js'
          # If you also want to run files in 'cypress/e2e/', you'd need another step or a pattern like 'cypress/e2e/**/*.cy.js,remwaste_cypressaut/**/*.cy.js'
          # If 'remwaste_cypressaut' is meant to be part of the Cypress project, ensure your cypress.config.js includes it in its 'specPattern'.

      # --- Run Robot Framework Tests ---
      - name: Run Robot Framework Tests
        # Your 'rem_tests.robot' file is in the root directory.
        run: robot rem_tests.robot
        # If 'rem_tests.robot' were inside a folder like 'robot_tests/', the command would be:
        # run: robot robot_tests/rem_tests.robot

      # --- Archive All Test Reports ---
      - name: Archive Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: all-test-reports
          path: |
            junit-report/junit.xml # Jest JUnit report (assuming configured via jest-junit)
            html-report/report.html # Jest HTML report (assuming configured via jest-html-reporters)
            coverage/ # Jest code coverage report folder
            output.xml # Default Robot Framework output XML
            log.html # Default Robot Framework log HTML
            report.html # Default Robot Framework report HTML
            # Add Cypress report paths if generated outside the 'cypress' folder or need specific archiving
            # e.g., cypress/reports/junit/ # For Cypress JUnit reports
          retention-days: 7
